<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva de Horas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.print.min.css" media="print" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <style>
        /* Estilos aquí */
    </style>

</head>

<body>
    <section id="reserva">
        <h2>Reserva tu hora</h2>
        <p>Selecciona una hora en el calendario para reservar:</p>

        <!-- Calendario aquí -->
        <div id="calendario"></div>
    </section>

    <script>
        const repoOwner = 'leitoxjpg';
        const repoName = 'aaaaaa';
        const filePath = 'reservas.json';
        const accessToken = 'https://leitoxjpg.github.io/aaaaaa/a.html';

        // Función para cargar reservas desde GitHub
        function cargarReservasDesdeGitHub(callback) {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;

            $.ajax({
                url: url,
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                },
                success: function (data) {
                    const content = atob(data.content);
                    const reservas = JSON.parse(content);
                    callback(reservas);
                },
                error: function (error) {
                    console.error('Error al cargar reservas desde GitHub:', error);
                },
            });
        }

        // Función para guardar reservas en GitHub
        function guardarReservasEnGitHub(reservas, callback) {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;

            const content = btoa(JSON.stringify(reservas));

            const data = {
                message: 'Actualizar reservas',
                content: content,
                sha: reservas.sha, // Incluir el sha actual del archivo
            };

            $.ajax({
                url: url,
                type: 'PUT',
                data: JSON.stringify(data),
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                },
                success: function (response) {
                    callback(response);
                },
                error: function (error) {
                    console.error('Error al guardar reservas en GitHub:', error);
                },
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            moment.locale('es');
            var lastSelection = null;

            cargarReservasDesdeGitHub(function (storedReservas) {
                $('#calendario').fullCalendar({
                    header: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'agendaWeek,agendaDay'
                    },
                    defaultView: 'agendaWeek',
                    selectable: true,
                    selectHelper: true,
                    unselectAuto: false,
                    selectLongPressDelay: 10,
                    select: function (start, end, jsEvent, view) {
                        if (esAdministrador()) {
                            if (lastSelection && start.isSameOrAfter(lastSelection.start) && start.isBefore(lastSelection.end)) {
                                $('#calendario').fullCalendar('unselect');
                                alert('No puedes seleccionar dos horas consecutivas.');
                            } else {
                                lastSelection = { start: start, end: end };
                                mostrarFormularioReserva(start, end);
                            }
                        } else {
                            $('#calendario').fullCalendar('unselect');
                            alert('Solo el administrador puede ocupar toda la jornada.');
                        }
                    },
                    unselect: function (view, jsEvent) {
                        lastSelection = null;
                    },
                    minTime: '11:00:00',
                    maxTime: '21:00:00',
                    slotDuration: '01:00:00',
                    businessHours: {
                        dow: [1, 2, 3, 4, 5, 6, 0],
                        start: '11:00',
                        end: '21:00'
                    },
                    events: storedReservas,
                    eventClick: function (calEvent, jsEvent, view) {
                        if (esAdministrador()) {
                            eliminarReserva(calEvent);
                        }
                    },
                });
            });
        });

        function mostrarFormularioReserva(start, end) {
            Swal.fire({
                title: 'Reserva de Hora',
                html: `
                    <p>Intervalo seleccionado: ${start.format('HH:mm')} - ${end.format('HH:mm')}</p>
                    <label for="nombre">Nombre:</label>
                    <input type="text" id="nombre" placeholder="Tu nombre" class="swal2-input">
                    <br>
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="Tu email" class="swal2-input">
                    <br>
                    <label for="telefono">Teléfono:</label>
                    <input type="tel" id="telefono" placeholder="Tu teléfono" class="swal2-input">
                `,
                showCancelButton: true,
                confirmButtonText: 'Confirmar Reserva',
                preConfirm: () => {
                    if (!$('#nombre').val() || !$('#email').val() || !$('#telefono').val()) {
                        Swal.showValidationMessage('Todos los campos son obligatorios');
                    } else {
                        return {
                            nombre: $('#nombre').val(),
                            email: $('#email').val(),
                            telefono: $('#telefono').val()
                        };
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    var nombre = result.value.nombre;
                    var email = result.value.email;
                    var telefono = result.value.telefono;

                    cargarReservasDesdeGitHub(function (storedReservas) {
                        var nuevaReserva = {
                            title: 'Reservado por ' + nombre,
                            start: start,
                            end: end,
                            email: email,
                            telefono: telefono
                        };

                        storedReservas.push(nuevaReserva);

                        guardarReservasEnGitHub(storedReservas, function () {
                            $('#calendario').fullCalendar('renderEvent', nuevaReserva, true);
                            Swal.fire('¡Reserva confirmada!', `Hora reservada para ${nombre} de ${start.format('HH:mm')} a ${end.format('HH:mm')}.`, 'success');
                        });
                    });
                } else {
                    $('#calendario').fullCalendar('unselect');
                }
            });
        }

        function eliminarReserva(calEvent) {
            if (esAdministrador()) {
                Swal.fire({
                    title: '¿Eliminar Reserva?',
                    text: `¿Estás seguro de eliminar la reserva de ${calEvent.title} de ${calEvent.start.format('HH:mm')} a ${calEvent.end.format('HH:mm')}?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        cargarReservasDesdeGitHub(function (storedReservas) {
                            storedReservas = storedReservas.filter(reserva => reserva.start && reserva.start.isSame && reserva.end.isSame &&
                                !(reserva.start.isSame(calEvent.start) && reserva.end.isSame(calEvent.end)));

                            guardarReservasEnGitHub(storedReservas, function () {
                                $('#calendario').fullCalendar('removeEvents', calEvent._id);
                                Swal.fire('Reserva eliminada', '', 'success');
                            });
                        });
                    }
                });
            } else {
                Swal.fire('Error', 'No tienes permisos para eliminar reservas.', 'error');
            }
        }

        function esAdministrador() {
            // Implementa tu lógica para verificar si el usuario es administrador
            // Por ejemplo, puedes agregar un campo 'administrador' en el objeto de usuario
            // y verificar su valor aquí.
            return true;
        }
    </script>
</body>

</html>
